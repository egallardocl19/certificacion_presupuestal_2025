<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Certificaciones Presupuestales - C√°ritas Lima</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 50%, #a5d6a7 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(1, 153, 82, 0.1);
            border-top: 4px solid #019952;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            height: 70px;
            max-width: 140px;
            width: auto;
            border-radius: 10px;
            object-fit: contain;
        }

        .header-text h1 {
            color: #019952;
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header-text .subtitle {
            color: #4a4a4a;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px;
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(1, 153, 82, 0.1);
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.6);
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #019952;
            font-weight: 600;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid transparent;
        }

        .nav-tab:hover {
            background: rgba(1, 153, 82, 0.1);
            transform: translateY(-2px);
            border-color: #019952;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #019952, #017a41);
            color: white;
            box-shadow: 0 4px 15px rgba(1, 153, 82, 0.4);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(1, 153, 82, 0.1);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #019952;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #019952;
            box-shadow: 0 0 0 3px rgba(1, 153, 82, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #019952, #017a41);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(1, 153, 82, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            border: 1px solid rgba(1, 153, 82, 0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: linear-gradient(135deg, #019952, #017a41);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tbody tr:hover {
            background: rgba(1, 153, 82, 0.05);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-borrador {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-enrevision {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-autorizacionpendiente {
            background: #fce4ec;
            color: #c2185b;
        }

        .status-activa {
            background: #e8f5e8;
            color: #019952;
        }

        .status-anulada {
            background: #ffebee;
            color: #d32f2f;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(1, 153, 82, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(1, 153, 82, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #019952;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(1, 153, 82, 0.15);
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #019952;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-weight: 500;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid;
        }

        .alert.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: rgba(1, 153, 82, 0.1);
            color: #017a41;
            border-left-color: #019952;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(1, 153, 82, 0.1);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(1, 153, 82, 0.1);
            border-top: 4px solid #019952;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .item-row, .firmante-row {
            background: rgba(1, 153, 82, 0.05);
            border: 1px solid rgba(1, 153, 82, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .ai-button {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .multiple-cert-container {
            border: 2px dashed #019952;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: rgba(1, 153, 82, 0.02);
        }

        .config-section {
            background: rgba(1, 153, 82, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(1, 153, 82, 0.1);
        }

        .auto-field {
            background: #f8f9fa !important;
            color: #6c757d;
            cursor: not-allowed;
        }

        .codigo-preview {
            background: rgba(1, 153, 82, 0.1);
            padding: 10px 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #019952;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .info-badge {
            display: inline-block;
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .info-text {
            font-size: 13px;
            color: #4a4a4a;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <img src="https://caritaslima.org.pe/wp-content/uploads/2023/06/LOGO-WEB.png" alt="C√°ritas Lima" class="logo">
                <div class="header-text">
                    <h1>Sistema de Certificaciones Presupuestales</h1>
                    <div class="subtitle">C√°ritas Lima - Gesti√≥n integral de certificaciones</div>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alert" class="alert"></div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>Cargando...</div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-tab="certificaciones">üìÑ Certificaciones</button>
            <button class="nav-tab" data-tab="nueva">‚ûï Nueva</button>
            <button class="nav-tab" data-tab="multiples">üìã M√∫ltiples</button>
            <button class="nav-tab" data-tab="reportes">üìà Reportes</button>
            <button class="nav-tab" data-tab="configuracion">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 style="color: #019952; margin-bottom: 25px;">Dashboard</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- Las estad√≠sticas se cargar√°n aqu√≠ -->
            </div>
            
            <h3 style="color: #019952; margin-bottom: 15px;">Certificaciones Recientes</h3>
            <div class="table-container">
                <table class="table" id="recentTable">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Fecha</th>
                            <th>Descripci√≥n</th>
                            <th>Estado</th>
                            <th>Monto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="recentTableBody">
                        <!-- Los datos se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Certificaciones Tab -->
        <div id="certificaciones" class="tab-content">
            <h2 style="color: #019952; margin-bottom: 25px;">Gesti√≥n de Certificaciones</h2>
            
            <!-- Filtros de b√∫squeda -->
            <div class="search-filters">
                <div class="form-group">
                    <label>B√∫squeda:</label>
                    <input type="text" id="searchText" placeholder="C√≥digo, descripci√≥n o solicitante...">
                </div>
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Borrador">Borrador</option>
                        <option value="En revisi√≥n">En revisi√≥n</option>
                        <option value="Autorizaci√≥n pendiente">Autorizaci√≥n pendiente</option>
                        <option value="Activa">Activa</option>
                        <option value="Anulada">Anulada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Oficina:</label>
                    <select id="filterOficina">
                        <option value="">Todas las oficinas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha desde:</label>
                    <input type="date" id="filterFechaDesde">
                </div>
                <div class="form-group">
                    <label>Fecha hasta:</label>
                    <input type="date" id="filterFechaHasta">
                </div>
                <div class="form-group" style="align-self: end;">
                    <button class="btn" onclick="aplicarFiltros()">üîç Buscar</button>
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">üîÑ Limpiar</button>
                </div>
            </div>

            <!-- Tabla de certificaciones -->
            <div class="table-container">
                <table class="table" id="certificacionesTable">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Fecha</th>
                            <th>Oficina</th>
                            <th>Descripci√≥n</th>
                            <th>Solicitante</th>
                            <th>Estado</th>
                            <th>Monto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="certificacionesTableBody">
                        <!-- Los datos se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Nueva Certificaci√≥n Tab -->
        <div id="nueva" class="tab-content">
            <h2 style="color: #019952; margin-bottom: 25px;">Nueva Certificaci√≥n</h2>
            
            <!-- Vista previa del c√≥digo -->
            <div class="codigo-preview" id="codigoPreview">
                C√≥digo: Se generar√° autom√°ticamente al guardar
            </div>
            
            <form id="nuevaCertificacionForm">
                <!-- Datos Generales -->
                <div class="config-section">
                    <h3 style="color: #019952;">üìã Datos Generales</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fechaCertificacion">üìÖ Fecha de Certificaci√≥n *</label>
                            <input type="date" id="fechaCertificacion" name="fechaCertificacion" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="oficina">üè¢ Oficina *</label>
                            <select id="oficina" name="oficina" required>
                                <option value="">Seleccione una oficina</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="descripcion">üìù Descripci√≥n *</label>
                        <textarea id="descripcion" name="descripcion" placeholder="Descripci√≥n detallada de la certificaci√≥n (ej: Adquisici√≥n de productos adicionales para completar los kits de ollas...)" required></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="iniciativa">üéØ Iniciativa *</label>
                            <select id="iniciativa" name="iniciativa" required>
                                <option value="">Seleccione una iniciativa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tipo">üìã Tipo *</label>
                            <select id="tipo" name="tipo" required>
                                <option value="">Seleccione un tipo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fuente">üí∞ Fuente de Financiamiento *</label>
                            <select id="fuente" name="fuente" required>
                                <option value="">Seleccione una fuente</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Solicitante (Configuraci√≥n) -->
                <div class="config-section">
                    <h3 style="color: #019952;">üë§ Solicitante</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="solicitanteId">Solicitante *</label>
                            <select id="solicitanteId" name="solicitanteId" onchange="cargarDatosSolicitante()" required>
                                <option value="">Seleccione un solicitante</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cargoSolicitante">Cargo * <span class="info-badge">Autom√°tico</span></label>
                            <input type="text" id="cargoSolicitante" name="cargoSolicitante" class="auto-field" readonly>
                        </div>
                        <div class="form-group">
                            <label for="emailSolicitante">Email <span class="info-badge">Autom√°tico</span></label>
                            <input type="email" id="emailSolicitante" name="emailSolicitante" class="auto-field" readonly>
                        </div>
                    </div>
                </div>

                <!-- √çtems -->
                <div class="config-section">
                    <h3 style="color: #019952;">üõí √çtems de la Certificaci√≥n</h3>
                    <button type="button" class="btn btn-secondary" onclick="agregarItem()">‚ûï Agregar √çtem</button>
                    <div id="itemsContainer">
                        <!-- Los √≠tems se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <div class="form-group">
                        <label><strong style="color: #019952;">üí≤ Total: S/ <span id="totalMonto">0.00</span></strong></label>
                        <div id="montoLetras" style="font-style: italic; color: #666; margin-top: 5px;"></div>
                    </div>
                </div>

                <!-- Firmantes (Configuraci√≥n) -->
                <div class="config-section">
                    <h3 style="color: #019952;">‚úçÔ∏è Firmantes</h3>
                    <div class="form-group">
                        <label for="cantidadFirmantes">Cantidad de Firmantes</label>
                        <select id="cantidadFirmantes" name="cantidadFirmantes" onchange="cargarFirmantes()">
                            <option value="1" selected>1 Firmante</option>
                            <option value="2">2 Firmantes</option>
                            <option value="3">3 Firmantes</option>
                        </select>
                    </div>
                    <div id="firmantesContainer">
                        <!-- Los firmantes se cargar√°n autom√°ticamente -->
                    </div>
                </div>

                <!-- Finalidad -->
                <div class="config-section">
                    <h3 style="color: #019952;">üìÑ Finalidad generada autom√°ticamente</h3>
                    <p class="info-text">La finalidad se actualiza de forma autom√°tica con base en la informaci√≥n ingresada, pero puede editarla si necesita a√±adir m√°s detalles.</p>
                    <div class="form-group" style="position: relative;">
                        <label for="finalidad">Finalidad</label>
                        <textarea id="finalidad" name="finalidad" placeholder="Finalidad o prop√≥sito espec√≠fico del gasto..." rows="5"></textarea>
                        <button type="button" class="ai-button" onclick="generarFinalidadConIA()">ü§ñ Generar con IA</button>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="action-buttons">
                    <button type="submit" class="btn">üíæ Crear Certificaci√≥n</button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">üîÑ Limpiar</button>
                    <button type="button" class="btn btn-info" onclick="previsualizarCertificacion()">üëÅÔ∏è Vista Previa</button>
                </div>
            </form>
        </div>

        <!-- Certificaciones M√∫ltiples Tab -->
        <div id="multiples" class="tab-content">
            <h2 style="color: #019952; margin-bottom: 25px;">Crear M√∫ltiples Certificaciones</h2>
            <p>Cree varias certificaciones al mismo tiempo utilizando datos similares.</p>
            
            <div class="multiple-cert-container">
                <h3 style="color: #019952;">üìã Datos Base (se aplicar√°n a todas las certificaciones)</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="baseFechaCertificacion">üìÖ Fecha Base</label>
                        <input type="date" id="baseFechaCertificacion">
                    </div>
                    <div class="form-group">
                        <label for="baseOficina">üè¢ Oficina Base</label>
                        <select id="baseOficina">
                            <option value="">Seleccione una oficina</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="baseIniciativa">üéØ Iniciativa Base</label>
                        <select id="baseIniciativa">
                            <option value="">Seleccione una iniciativa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="baseTipo">üìã Tipo Base</label>
                        <select id="baseTipo">
                            <option value="">Seleccione un tipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="baseFuente">üí∞ Fuente Base</label>
                        <select id="baseFuente">
                            <option value="">Seleccione una fuente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="baseSolicitante">üë§ Solicitante Base</label>
                        <select id="baseSolicitante">
                            <option value="">Seleccione un solicitante</option>
                        </select>
                    </div>
                </div>

                <button type="button" class="btn" onclick="agregarCertificacionMultiple()">‚ûï Agregar Certificaci√≥n</button>
                
                <div id="certificacionesMultiples">
                    <!-- Las certificaciones m√∫ltiples se agregar√°n aqu√≠ -->
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn" onclick="crearCertificacionesMultiples()">üíæ Crear Todas las Certificaciones</button>
                    <button type="button" class="btn btn-danger" onclick="limpiarCertificacionesMultiples()">üóëÔ∏è Limpiar Todo</button>
                </div>
            </div>
        </div>

        <!-- Reportes Tab -->
        <div id="reportes" class="tab-content">
            <h2 style="color: #019952; margin-bottom: 25px;">üìä Reportes y Estad√≠sticas</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="tipoReporte">Tipo de Reporte</label>
                    <select id="tipoReporte">
                        <option value="resumen">Resumen General</option>
                        <option value="por_estado">Por Estado</option>
                        <option value="por_oficina">Por Oficina</option>
                        <option value="por_periodo">Por Per√≠odo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reporteFechaDesde">Fecha Desde</label>
                    <input type="date" id="reporteFechaDesde">
                </div>
                <div class="form-group">
                    <label for="reporteFechaHasta">Fecha Hasta</label>
                    <input type="date" id="reporteFechaHasta">
                </div>
                <div class="form-group" style="align-self: end;">
                    <button class="btn" onclick="generarReporte()">üìä Generar Reporte</button>
                </div>
            </div>

            <div id="reporteResultado">
                <!-- Los resultados del reporte se mostrar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Configuraci√≥n Tab (NUEVO) -->
        <div id="configuracion" class="tab-content">
            <h2 style="color: #019952; margin-bottom: 25px;">‚öôÔ∏è Configuraci√≥n del Sistema</h2>
            
            <div class="nav-tabs" style="margin-bottom: 20px;">
                <button class="nav-tab active" data-config="solicitantes">üë§ Solicitantes</button>
                <button class="nav-tab" data-config="firmantes">‚úçÔ∏è Firmantes</button>
                <button class="nav-tab" data-config="general">üîß General</button>
                <button class="nav-tab" data-config="catalogos">üìö Cat√°logos</button>
            </div>

            <div id="configContent">
                <!-- El contenido de configuraci√≥n se cargar√° aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let certificaciones = [];
        let catalogos = {
            iniciativas: [],
            tipos: [],
            fuentes: [],
            finalidades: [],
            oficinas: [],
            plantillas: [],
            solicitantes: [],
            firmantes: []
        };
        let configuracion = {};
        let contadorItems = 0;
        let contadorFirmantes = 0;
        let contadorMultiples = 0;
        let finalidadEditadaManual = false;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando aplicaci√≥n...');
            inicializarApp();
            configurarEventos();
        });

        // Configurar eventos principales
        function configurarEventos() {
            // Tabs principales
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    const configId = this.getAttribute('data-config');
                    
                    if (tabId) {
                        cambiarTab(tabId);
                    } else if (configId) {
                        cambiarConfigTab(configId);
                    }
                });
            });

            // Formulario de nueva certificaci√≥n
            document.getElementById('nuevaCertificacionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevaCertificacion();
            });

            const campoFinalidad = document.getElementById('finalidad');
            if (campoFinalidad) {
                campoFinalidad.addEventListener('input', () => {
                    finalidadEditadaManual = campoFinalidad.value.trim().length > 0;
                    if (!finalidadEditadaManual) {
                        actualizarFinalidadAutomatica(true);
                    }
                });
            }

            ['descripcion', 'iniciativa', 'tipo', 'fuente', 'oficina'].forEach(id => {
                const elemento = document.getElementById(id);
                if (!elemento) return;
                const evento = elemento.tagName === 'TEXTAREA' ? 'input' : 'change';
                elemento.addEventListener(evento, () => {
                    if (!finalidadEditadaManual || !document.getElementById('finalidad').value.trim()) {
                        actualizarFinalidadAutomatica();
                    }
                });
            });

            // Eventos de filtros
            document.getElementById('searchText').addEventListener('input', debounce(aplicarFiltros, 300));

            // Establecer fecha actual por defecto
            document.getElementById('fechaCertificacion').value = new Date().toISOString().split('T')[0];
            document.getElementById('baseFechaCertificacion').value = new Date().toISOString().split('T')[0];

            actualizarFinalidadAutomatica(true);
        }

        // Funci√≥n debounce para optimizar b√∫squedas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Inicializar aplicaci√≥n
        function inicializarApp() {
            mostrarLoading(true, 'Cargando sistema...');

            Promise.all([
                cargarCatalogos(),
                cargarCertificaciones(),
                cargarEstadisticasDashboard(),
                cargarConfiguracion()
            ]).then(() => {
                mostrarAlerta('Sistema cargado correctamente', 'success');
                console.log('Sistema cargado exitosamente');
            }).catch(error => {
                mostrarAlerta('Error al cargar el sistema: ' + error.message, 'error');
                console.error('Error cargando sistema:', error);
            }).finally(() => {
                cargarTablaCertificaciones();
                cargarTablaCertificacionesRecientes();
                mostrarLoading(false);
            });
        }

        // Cargar configuraci√≥n
        function cargarConfiguracion() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(data => {
                        configuracion = data || {};
                        console.log('Configuraci√≥n cargada:', configuracion);
                        resolve();
                    })
                    .withFailureHandler(error => {
                        console.error('Error cargando configuraci√≥n:', error);
                        configuracion = {};
                        resolve(); // No fallar por esto
                    })
                    .obtenerConfiguracionGeneral();
            });
        }

        // Cargar cat√°logos
        function cargarCatalogos() {
            return new Promise((resolve, reject) => {
                const tipos = ['iniciativas', 'tipos', 'fuentes', 'finalidades', 'oficinas', 'plantillas', 'solicitantes', 'firmantes'];
                let cargados = 0;

                tipos.forEach(tipo => {
                    google.script.run
                        .withSuccessHandler(data => {
                            catalogos[tipo] = data || [];
                            cargados++;
                            console.log(`Cat√°logo ${tipo} cargado:`, data);
                            if (cargados === tipos.length) {
                                llenarSelectoresCatalogos();
                                cargarFirmantes(); // Cargar firmante por defecto
                                resolve();
                            }
                        })
                        .withFailureHandler(error => {
                            console.error(`Error cargando cat√°logo ${tipo}:`, error);
                            catalogos[tipo] = [];
                            cargados++;
                            if (cargados === tipos.length) {
                                llenarSelectoresCatalogos();
                                cargarFirmantes();
                                resolve();
                            }
                        })
                        .obtenerCatalogo(tipo);
                });
            });
        }

        // Cargar certificaciones
        function cargarCertificaciones() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(data => {
                        certificaciones = data || [];
                        console.log('Certificaciones cargadas:', certificaciones.length);
                        cargarTablaCertificaciones();
                        cargarTablaCertificacionesRecientes();
                        resolve();
                    })
                    .withFailureHandler(error => {
                        console.error('Error cargando certificaciones:', error);
                        certificaciones = [];
                        cargarTablaCertificaciones();
                        reject(error);
                    })
                    .obtenerCertificaciones();
            });
        }

        // Cargar estad√≠sticas del dashboard
        function cargarEstadisticasDashboard() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resultado => {
                        console.log('Estad√≠sticas recibidas:', resultado);
                        if (resultado.success) {
                            mostrarEstadisticas(resultado.data);
                            cargarTablaCertificacionesRecientes(resultado.data.certificacionesRecientes || []);
                        } else {
                            console.error('Error en estad√≠sticas:', resultado.error);
                            mostrarEstadisticasVacias();
                        }
                        resolve();
                    })
                    .withFailureHandler(error => {
                        console.error('Error cargando estad√≠sticas:', error);
                        mostrarEstadisticasVacias();
                        resolve();
                    })
                    .obtenerEstadisticasDashboard();
            });
        }

        // Mostrar estad√≠sticas en el dashboard
        function mostrarEstadisticas(data) {
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="number">${data.total || 0}</div>
                    <div class="label">Total Certificaciones</div>
                </div>
                <div class="stat-card">
                    <div class="number">S/ ${(data.montoTotal || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}</div>
                    <div class="label">Monto Total</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.porEstado?.Activa || 0}</div>
                    <div class="label">Activas</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.porEstado?.['Autorizaci√≥n pendiente'] || 0}</div>
                    <div class="label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="number">${data.porEstado?.Borrador || 0}</div>
                    <div class="label">Borradores</div>
                </div>
            `;
        }

        // Mostrar estad√≠sticas vac√≠as cuando no hay datos
        function mostrarEstadisticasVacias() {
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="number">0</div>
                    <div class="label">Total Certificaciones</div>
                </div>
                <div class="stat-card">
                    <div class="number">S/ 0.00</div>
                    <div class="label">Monto Total</div>
                </div>
                <div class="stat-card">
                    <div class="number">0</div>
                    <div class="label">Activas</div>
                </div>
                <div class="stat-card">
                    <div class="number">0</div>
                    <div class="label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="number">0</div>
                    <div class="label">Borradores</div>
                </div>
            `;
        }

        // Llenar selectores con datos de cat√°logos
        function llenarSelectoresCatalogos() {
            // Oficinas
            const selectoresOficina = document.querySelectorAll('#oficina, #filterOficina, #baseOficina');
            selectoresOficina.forEach(select => {
                if (!select) return;
                const valorActual = select.value;
                select.innerHTML = select.id.includes('filter') ? '<option value="">Todas las oficinas</option>' : '<option value="">Seleccione una oficina</option>';
                catalogos.oficinas.forEach(oficina => {
                    if (oficina.activo) {
                        const option = document.createElement('option');
                        option.value = oficina.codigo;
                        option.textContent = oficina.nombre;
                        select.appendChild(option);
                    }
                });
                if (valorActual) select.value = valorActual;
            });

            // Iniciativas
            const selectoresIniciativa = document.querySelectorAll('#iniciativa, #baseIniciativa');
            selectoresIniciativa.forEach(select => {
                if (!select) return;
                const valorActual = select.value;
                select.innerHTML = '<option value="">Seleccione una iniciativa</option>';
                catalogos.iniciativas.forEach(iniciativa => {
                    if (iniciativa.activo) {
                        const option = document.createElement('option');
                        option.value = iniciativa.codigo;
                        option.textContent = iniciativa.nombre;
                        select.appendChild(option);
                    }
                });
                if (valorActual) select.value = valorActual;
            });

            // Tipos
            const selectoresTipo = document.querySelectorAll('#tipo, #baseTipo');
            selectoresTipo.forEach(select => {
                if (!select) return;
                const valorActual = select.value;
                select.innerHTML = '<option value="">Seleccione un tipo</option>';
                catalogos.tipos.forEach(tipo => {
                    if (tipo.activo) {
                        const option = document.createElement('option');
                        option.value = tipo.codigo;
                        option.textContent = tipo.nombre;
                        select.appendChild(option);
                    }
                });
                if (valorActual) select.value = valorActual;
            });

            // Fuentes
            const selectoresFuente = document.querySelectorAll('#fuente, #baseFuente');
            selectoresFuente.forEach(select => {
                if (!select) return;
                const valorActual = select.value;
                select.innerHTML = '<option value="">Seleccione una fuente</option>';
                catalogos.fuentes.forEach(fuente => {
                    if (fuente.activo) {
                        const option = document.createElement('option');
                        option.value = fuente.codigo;
                        option.textContent = fuente.nombre;
                        select.appendChild(option);
                    }
                });
                if (valorActual) select.value = valorActual;
            });

            // Solicitantes
            const selectoresSolicitante = document.querySelectorAll('#solicitanteId, #baseSolicitante');
            selectoresSolicitante.forEach(select => {
                if (!select) return;
                const valorActual = select.value;
                select.innerHTML = '<option value="">Seleccione un solicitante</option>';
                catalogos.solicitantes.forEach(solicitante => {
                    if (solicitante.activo) {
                        const option = document.createElement('option');
                        option.value = solicitante.id;
                        option.textContent = solicitante.nombre;
                        select.appendChild(option);
                    }
                });
                if (valorActual) select.value = valorActual;
            });

            if (!finalidadEditadaManual || !document.getElementById('finalidad').value.trim()) {
                actualizarFinalidadAutomatica(true);
            }

            console.log('Selectores llenados con cat√°logos');
        }

        // Cambiar entre tabs principales
        function cambiarTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab[data-tab]').forEach(tab => {
                tab.classList.remove('active');
            });

            const selectedTab = document.querySelector(`[data-tab="${tabId}"]`);
            const selectedContent = document.getElementById(tabId);

            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');

                switch(tabId) {
                    case 'dashboard':
                        cargarDashboard();
                        break;
                    case 'certificaciones':
                        cargarTablaCertificaciones();
                        break;
                    case 'nueva':
                        setTimeout(() => {
                            if (document.getElementById('itemsContainer').children.length === 0) {
                                agregarItem();
                            }
                        }, 100);
                        break;
                    case 'configuracion':
                        cambiarConfigTab('solicitantes');
                        break;
                }
            }
        }

        // Cambiar entre tabs de configuraci√≥n
        function cambiarConfigTab(configId) {
            document.querySelectorAll('.nav-tab[data-config]').forEach(tab => {
                tab.classList.remove('active');
            });

            const selectedTab = document.querySelector(`[data-config="${configId}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                cargarConfiguracion(configId);
            }
        }

        // NUEVAS FUNCIONES PARA LAS FUNCIONALIDADES ACTUALIZADAS

        // Cargar datos del solicitante autom√°ticamente
        function cargarDatosSolicitante() {
            const solicitanteId = document.getElementById('solicitanteId').value;
            const cargoField = document.getElementById('cargoSolicitante');
            const emailField = document.getElementById('emailSolicitante');

            if (!solicitanteId) {
                cargoField.value = '';
                emailField.value = '';
                return;
            }

            const solicitante = catalogos.solicitantes.find(s => s.id === solicitanteId);
            if (solicitante) {
                cargoField.value = solicitante.cargo;
                emailField.value = solicitante.email;
            }
        }

        function obtenerFinalidadAutomatica() {
            const descripcion = document.getElementById('descripcion')?.value || '';
            const oficina = document.getElementById('oficina')?.value || '';
            const iniciativa = document.getElementById('iniciativa')?.value || '';
            const tipo = document.getElementById('tipo')?.value || '';
            const fuente = document.getElementById('fuente')?.value || '';

            let finalidad = 'Atender oportunamente las necesidades operativas de C√°ritas Lima.';

            const desc = descripcion.toLowerCase();

            if (desc.includes('adquisic') || desc.includes('compra') || desc.includes('productos') || desc.includes('materiales')) {
                if (desc.includes('alimento') || desc.includes('kit') || desc.includes('ollas') || desc.includes('v√≠veres')) {
                    finalidad = 'Complementar con recursos adicionales la conformaci√≥n de kits alimentarios para la atenci√≥n de familias vulnerables.';
                } else if (desc.includes('oficina') || desc.includes('administrativ') || desc.includes('equipos')) {
                    finalidad = 'Fortalecer la capacidad operativa administrativa de la instituci√≥n mediante la provisi√≥n de bienes esenciales.';
                } else {
                    finalidad = 'Complementar las operaciones institucionales con la adquisici√≥n de insumos y materiales necesarios.';
                }
            } else if (desc.includes('servicio') || desc.includes('consultor√≠') || desc.includes('capacitaci√≥n')) {
                if (desc.includes('capacitaci√≥n') || desc.includes('formaci√≥n')) {
                    finalidad = 'Fortalecer las capacidades del personal para mejorar la atenci√≥n a beneficiarios y aliados estrat√©gicos.';
                } else {
                    finalidad = 'Mejorar la calidad de los servicios brindados a la comunidad a trav√©s de la contrataci√≥n especializada correspondiente.';
                }
            }

            const complementos = [];
            const iniciativaNombre = obtenerNombreCatalogo('iniciativas', iniciativa);
            const oficinaNombre = obtenerNombreCatalogo('oficinas', oficina);
            const tipoNombre = obtenerNombreCatalogo('tipos', tipo);
            const fuenteNombre = obtenerNombreCatalogo('fuentes', fuente);

            if (iniciativaNombre) {
                complementos.push(`en el marco de la iniciativa "${iniciativaNombre}"`);
            }
            if (oficinaNombre) {
                complementos.push(`desde la ${oficinaNombre}`);
            }
            if (tipoNombre) {
                complementos.push(`a trav√©s del tipo ${tipoNombre.toLowerCase()}`);
            }
            if (fuenteNombre) {
                complementos.push(`financiado con recursos de ${fuenteNombre}`);
            }

            if (complementos.length > 0) {
                finalidad += ' ' + complementos.join(', ') + '.';
            } else if (!finalidad.endsWith('.')) {
                finalidad += '.';
            }

            return finalidad;
        }

        function actualizarFinalidadAutomatica(forzar = false) {
            const campoFinalidad = document.getElementById('finalidad');
            if (!campoFinalidad) return;

            const finalidadGenerada = obtenerFinalidadAutomatica();
            const valorActual = campoFinalidad.value.trim();

            if (!finalidadGenerada) return;

            if (forzar || !valorActual || !finalidadEditadaManual) {
                campoFinalidad.value = finalidadGenerada;
                finalidadEditadaManual = false;
            }
        }

        // Cargar firmantes seg√∫n cantidad seleccionada
        function cargarFirmantes() {
            const cantidad = parseInt(document.getElementById('cantidadFirmantes').value) || 1;
            const container = document.getElementById('firmantesContainer');
            
            container.innerHTML = '';
            
            for (let i = 1; i <= cantidad; i++) {
                const firmanteDiv = document.createElement('div');
                firmanteDiv.className = 'firmante-row';
                firmanteDiv.innerHTML = `
                    <h4 style="color: #019952;">Firmante ${i}</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Seleccionar Firmante *</label>
                            <select name="firmante${i}Id" onchange="cargarDatosFirmante(${i})" required>
                                <option value="">Seleccione un firmante</option>
                                ${catalogos.firmantes.map(f => `<option value="${f.id}">${f.nombre}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nombre * <span class="info-badge">Autom√°tico</span></label>
                            <input type="text" name="firmante${i}Nombre" class="auto-field" readonly required>
                        </div>
                        <div class="form-group">
                            <label>Cargo * <span class="info-badge">Autom√°tico</span></label>
                            <input type="text" name="firmante${i}Cargo" class="auto-field" readonly required>
                        </div>
                    </div>
                `;
                container.appendChild(firmanteDiv);
            }

            // Cargar firmante por defecto para el primer firmante
            if (cantidad >= 1 && catalogos.firmantes.length > 0) {
                const primerFirmante = catalogos.firmantes.find(f => f.orden === 1) || catalogos.firmantes[0];
                const select = container.querySelector('[name="firmante1Id"]');
                const nombreField = container.querySelector('[name="firmante1Nombre"]');
                const cargoField = container.querySelector('[name="firmante1Cargo"]');
                
                if (select && primerFirmante) {
                    select.value = primerFirmante.id;
                    nombreField.value = primerFirmante.nombre;
                    cargoField.value = primerFirmante.cargo;
                }
            }
        }

        // Cargar datos del firmante autom√°ticamente
        function cargarDatosFirmante(index) {
            const firmanteId = document.querySelector(`[name="firmante${index}Id"]`).value;
            const nombreField = document.querySelector(`[name="firmante${index}Nombre"]`);
            const cargoField = document.querySelector(`[name="firmante${index}Cargo"]`);

            if (!firmanteId) {
                nombreField.value = '';
                cargoField.value = '';
                return;
            }

            const firmante = catalogos.firmantes.find(f => f.id === firmanteId);
            if (firmante) {
                nombreField.value = firmante.nombre;
                cargoField.value = firmante.cargo;
            }
        }

        // Cargar dashboard
        function cargarDashboard() {
            cargarEstadisticasDashboard();
        }

        // Cargar tabla de certificaciones recientes
        function cargarTablaCertificacionesRecientes(certificacionesRecientes = null) {
            const tbody = document.getElementById('recentTableBody');
            if (!tbody) return;
            
            const recientes = certificacionesRecientes || certificaciones.slice(0, 10);
            
            tbody.innerHTML = '';
            
            if (recientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">
                            <div>üìÑ</div>
                            <div>No hay certificaciones registradas</div>
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="cambiarTab('nueva')">Crear Primera Certificaci√≥n</button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            recientes.forEach(cert => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${cert.codigo}</td>
                    <td>${formatearFecha(cert.fechaEmision)}</td>
                    <td>${cert.descripcion ? cert.descripcion.substring(0, 50) + '...' : 'Sin descripci√≥n'}</td>
                    <td><span class="status-badge status-${obtenerClaseEstado(cert.estado)}">${cert.estado}</span></td>
                    <td>S/ ${(cert.montoTotal || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}</td>
                    <td>
                        <button class="btn btn-info" onclick="verCertificacion('${cert.codigo}')" style="padding: 5px 10px; font-size: 12px;">üëÅÔ∏è Ver</button>
                        ${cert.urlPDF ? `<button class="btn btn-secondary" onclick="window.open('${cert.urlPDF}', '_blank')" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">üìÑ PDF</button>` : ''}
                    </td>
                `;
                tbody.appendChild(fila);
            });
        }

        // Cargar tabla principal de certificaciones
        function cargarTablaCertificaciones() {
            const tbody = document.getElementById('certificacionesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (certificaciones.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">
                            <div>üìÑ</div>
                            <div>No hay certificaciones registradas</div>
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="cambiarTab('nueva')">Crear Primera Certificaci√≥n</button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            certificaciones.forEach(cert => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${cert.codigo}</td>
                    <td>${formatearFecha(cert.fechaEmision)}</td>
                    <td>${obtenerNombreCatalogo('oficinas', cert.oficina)}</td>
                    <td>${cert.descripcion ? cert.descripcion.substring(0, 40) + '...' : 'Sin descripci√≥n'}</td>
                    <td>${cert.solicitante || 'Sin solicitante'}</td>
                    <td><span class="status-badge status-${obtenerClaseEstado(cert.estado)}">${cert.estado}</span></td>
                    <td>S/ ${(cert.montoTotal || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}</td>
                    <td>
                        <button class="btn btn-info" onclick="verCertificacion('${cert.codigo}')" style="padding: 5px 8px; font-size: 11px; margin: 2px;">üëÅÔ∏è</button>
                        <button class="btn btn-warning" onclick="editarCertificacion('${cert.codigo}')" style="padding: 5px 8px; font-size: 11px; margin: 2px;">‚úèÔ∏è</button>
                        ${cert.estado !== 'Anulada' ? `<button class="btn btn-danger" onclick="anularCertificacion('${cert.codigo}')" style="padding: 5px 8px; font-size: 11px; margin: 2px;">‚ùå</button>` : ''}
                        ${cert.urlPDF ? `<button class="btn btn-secondary" onclick="window.open('${cert.urlPDF}', '_blank')" style="padding: 5px 8px; font-size: 11px; margin: 2px;">üìÑ</button>` : ''}
                        <button class="btn btn-info" onclick="generarDocumento('${cert.codigo}')" style="padding: 5px 8px; font-size: 11px; margin: 2px;">üìù</button>
                    </td>
                `;
                tbody.appendChild(fila);
            });
        }

        // Aplicar filtros a la tabla
        function aplicarFiltros() {
            const textoBusqueda = document.getElementById('searchText').value.toLowerCase();
            const estadoFiltro = document.getElementById('filterEstado').value;
            const oficinaFiltro = document.getElementById('filterOficina').value;

            const tbody = document.getElementById('certificacionesTableBody');
            if (!tbody) return;
            
            const filas = tbody.getElementsByTagName('tr');

            Array.from(filas).forEach(fila => {
                if (fila.cells.length < 7) return;
                
                const codigo = fila.cells[0].textContent.toLowerCase();
                const descripcion = fila.cells[3].textContent.toLowerCase();
                const solicitante = fila.cells[4].textContent.toLowerCase();
                const estado = fila.cells[5].textContent.trim();

                let mostrar = true;

                if (textoBusqueda && !codigo.includes(textoBusqueda) && 
                    !descripcion.includes(textoBusqueda) && !solicitante.includes(textoBusqueda)) {
                    mostrar = false;
                }

                if (estadoFiltro && estado !== estadoFiltro) {
                    mostrar = false;
                }

                fila.style.display = mostrar ? '' : 'none';
            });
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('searchText').value = '';
            document.getElementById('filterEstado').value = '';
            document.getElementById('filterOficina').value = '';
            document.getElementById('filterFechaDesde').value = '';
            document.getElementById('filterFechaHasta').value = '';
            aplicarFiltros();
        }

        // Agregar nuevo √≠tem
        function agregarItem() {
            contadorItems++;
            const container = document.getElementById('itemsContainer');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.id = `item-${contadorItems}`;
            
            itemDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="eliminarItem(${contadorItems})">√ó</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Descripci√≥n *</label>
                        <input type="text" name="itemDescripcion" placeholder="Descripci√≥n del √≠tem" required>
                    </div>
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" name="itemCantidad" min="1" step="0.01" placeholder="1" required onchange="calcularSubtotal(${contadorItems})">
                    </div>
                    <div class="form-group">
                        <label>Unidad</label>
                        <input type="text" name="itemUnidad" placeholder="Unidad, Kilogramo, Litro..." value="Unidad">
                    </div>
                    <div class="form-group">
                        <label>Precio Unitario *</label>
                        <input type="number" name="itemPrecio" min="0" step="0.01" placeholder="0.00" required onchange="calcularSubtotal(${contadorItems})">
                    </div>
                    <div class="form-group">
                        <label>Subtotal</label>
                        <input type="number" name="itemSubtotal" readonly placeholder="0.00" style="background: #f8f9fa;">
                    </div>
                </div>
            `;
            
            container.appendChild(itemDiv);
        }

        // Eliminar √≠tem
        function eliminarItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (item) {
                item.remove();
                calcularTotal();
            }
        }

        // Calcular subtotal de un √≠tem
        function calcularSubtotal(id) {
            const item = document.getElementById(`item-${id}`);
            if (!item) return;

            const cantidad = parseFloat(item.querySelector('[name="itemCantidad"]').value) || 0;
            const precio = parseFloat(item.querySelector('[name="itemPrecio"]').value) || 0;
            const subtotal = cantidad * precio;
            
            item.querySelector('[name="itemSubtotal"]').value = subtotal.toFixed(2);
            calcularTotal();
        }

        // Calcular total general
        function calcularTotal() {
            const items = document.querySelectorAll('.item-row');
            let total = 0;

            items.forEach(item => {
                const subtotal = parseFloat(item.querySelector('[name="itemSubtotal"]').value) || 0;
                total += subtotal;
            });

            document.getElementById('totalMonto').textContent = total.toLocaleString('es-PE', {minimumFractionDigits: 2});
            
            // Convertir a letras
            google.script.run
                .withSuccessHandler(resultado => {
                    if (resultado && resultado.success) {
                        document.getElementById('montoLetras').textContent = resultado.montoLetras;
                    }
                })
                .withFailureHandler(error => {
                    console.error('Error convirtiendo a letras:', error);
                })
                .convertirNumeroALetras(total);
        }

        // Generar finalidad con IA
        function generarFinalidadConIA() {
            const datos = {
                descripcion: document.getElementById('descripcion').value,
                iniciativa: obtenerNombreCatalogo('iniciativas', document.getElementById('iniciativa').value),
                tipo: obtenerNombreCatalogo('tipos', document.getElementById('tipo').value),
                fuente: obtenerNombreCatalogo('fuentes', document.getElementById('fuente').value),
                oficina: obtenerNombreCatalogo('oficinas', document.getElementById('oficina').value),
                montoEstimado: document.getElementById('totalMonto').textContent.replace(',', '')
            };

            if (!datos.descripcion) {
                mostrarAlerta('Por favor, complete la descripci√≥n antes de generar la finalidad', 'error');
                return;
            }

            mostrarLoading(true, 'Generando finalidad con IA...');

            google.script.run
                .withSuccessHandler(resultado => {
                    mostrarLoading(false);
                    if (resultado.success) {
                        document.getElementById('finalidad').value = resultado.finalidad;
                        finalidadEditadaManual = true;
                        mostrarAlerta('Finalidad generada exitosamente', 'success');
                    } else {
                        mostrarAlerta('Error al generar finalidad: ' + resultado.error, 'error');
                        document.getElementById('finalidad').value = resultado.finalidad || 'Error al generar finalidad autom√°tica. Por favor, elabore una finalidad manual.';
                        finalidadEditadaManual = true;
                    }
                })
                .withFailureHandler(error => {
                    mostrarLoading(false);
                    mostrarAlerta('Error de conexi√≥n al generar la finalidad: ' + error.message, 'error');
                    finalidadEditadaManual = true;
                })
                .generarFinalidadConIA(datos);
        }

        // Guardar nueva certificaci√≥n
        function guardarNuevaCertificacion() {
            const form = document.getElementById('nuevaCertificacionForm');
            const formData = new FormData(form);
            
            // Recolectar datos del formulario
            const datos = {
                fecha: formData.get('fechaCertificacion'),
                descripcion: formData.get('descripcion'),
                oficina: formData.get('oficina'),
                iniciativa: formData.get('iniciativa'),
                tipo: formData.get('tipo'),
                fuente: formData.get('fuente'),
                finalidad: (formData.get('finalidad') || '').trim(),
                items: [],
                firmantes: []
            };

            // Obtener datos del solicitante seleccionado
            const solicitanteId = formData.get('solicitanteId');
            if (solicitanteId) {
                const solicitante = catalogos.solicitantes.find(s => s.id === solicitanteId);
                if (solicitante) {
                    datos.solicitante = solicitante.nombre;
                    datos.cargoSolicitante = solicitante.cargo;
                    datos.emailSolicitante = solicitante.email;
                }
            }

            // Recolectar √≠tems
            document.querySelectorAll('.item-row').forEach(item => {
                const itemData = {
                    descripcion: item.querySelector('[name="itemDescripcion"]').value,
                    cantidad: parseFloat(item.querySelector('[name="itemCantidad"]').value) || 0,
                    unidad: item.querySelector('[name="itemUnidad"]').value,
                    precioUnitario: parseFloat(item.querySelector('[name="itemPrecio"]').value) || 0
                };
                datos.items.push(itemData);
            });

            // Recolectar firmantes
            document.querySelectorAll('.firmante-row').forEach((firmante, index) => {
                const nombreField = firmante.querySelector(`[name="firmante${index + 1}Nombre"]`);
                const cargoField = firmante.querySelector(`[name="firmante${index + 1}Cargo"]`);
                
                if (nombreField && cargoField) {
                    const firmanteData = {
                        nombre: nombreField.value,
                        cargo: cargoField.value,
                        obligatorio: true
                    };
                    datos.firmantes.push(firmanteData);
                }
            });

            // Validar datos b√°sicos
            if (!datos.fecha || !datos.descripcion || !datos.oficina || !datos.solicitante) {
                mostrarAlerta('Por favor, complete todos los campos obligatorios', 'error');
                return;
            }

            if (datos.items.length === 0) {
                mostrarAlerta('Debe agregar al menos un √≠tem', 'error');
                return;
            }

            mostrarAlerta('Creando certificaci√≥n, por favor espere...', 'info');
            mostrarLoading(true, 'Creando certificaci√≥n...');

            google.script.run
                .withSuccessHandler(resultado => {
                    mostrarLoading(false);
                    if (resultado.success) {
                        mostrarAlerta(`Certificaci√≥n creada exitosamente. C√≥digo: ${resultado.codigo}`, 'success');
                        limpiarFormulario();
                        cargarCertificaciones().then(() => {
                            cargarTablaCertificaciones();
                            cargarEstadisticasDashboard();
                        });
                    } else {
                        mostrarAlerta('Error al crear la certificaci√≥n: ' + resultado.error, 'error');
                    }
                })
                .withFailureHandler(error => {
                    mostrarLoading(false);
                    mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
                })
                .crearCertificacion(datos);
        }

        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('nuevaCertificacionForm').reset();
            document.getElementById('itemsContainer').innerHTML = '';
            document.getElementById('firmantesContainer').innerHTML = '';
            document.getElementById('totalMonto').textContent = '0.00';
            document.getElementById('montoLetras').textContent = '';
            document.getElementById('fechaCertificacion').value = new Date().toISOString().split('T')[0];
            contadorItems = 0;
            finalidadEditadaManual = false;

            // Reinicializar
            setTimeout(() => {
                agregarItem();
                cargarFirmantes();
                actualizarFinalidadAutomatica(true);
            }, 100);
        }

        // Generar documento de certificaci√≥n
        function generarDocumento(codigo) {
            if (!codigo) return;
            
            mostrarLoading(true, 'Generando documento...');
            
            google.script.run
                .withSuccessHandler(resultado => {
                    mostrarLoading(false);
                    if (resultado.success) {
                        mostrarAlerta('Documento generado exitosamente', 'success');
                        if (resultado.urlPDF) {
                            window.open(resultado.urlPDF, '_blank');
                        }
                        // Recargar tabla para actualizar URLs
                        cargarCertificaciones().then(() => {
                            cargarTablaCertificaciones();
                        });
                    } else {
                        mostrarAlerta('Error al generar documento: ' + resultado.error, 'error');
                    }
                })
                .withFailureHandler(error => {
                    mostrarLoading(false);
                    mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
                })
                .generarDocumentoCertificacion(codigo);
        }

        // Funciones auxiliares
        function mostrarLoading(show, mensaje = 'Cargando...') {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
                if (mensaje !== 'Cargando...') {
                    loading.querySelector('div:last-child').textContent = mensaje;
                }
            } else {
                loading.classList.remove('show');
                loading.querySelector('div:last-child').textContent = 'Cargando...';
            }
        }

        function mostrarAlerta(mensaje, tipo) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${tipo} show`;
            alert.textContent = mensaje;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function formatearFecha(fecha) {
            if (!fecha) return '';
            const f = new Date(fecha);
            return f.toLocaleDateString('es-PE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function obtenerNombreCatalogo(tipo, codigo) {
            if (!codigo || !catalogos[tipo]) return codigo || '';
            const item = catalogos[tipo].find(i => i.codigo === codigo);
            return item ? item.nombre : codigo;
        }

        function obtenerClaseEstado(estado) {
            if (!estado) return '';
            return estado.toLowerCase()
                .replace(/\s+/g, '')
                .replace('√≥', 'o')
                .replace('√±', 'n');
        }

        // Funciones para acciones de certificaciones
        function verCertificacion(codigo) {
            mostrarAlerta(`Ver certificaci√≥n ${codigo} - Funci√≥n por implementar`, 'info');
        }

        function editarCertificacion(codigo) {
            mostrarAlerta(`Editar certificaci√≥n ${codigo} - Funci√≥n por implementar`, 'info');
        }

        function anularCertificacion(codigo) {
            if (confirm(`¬øEst√° seguro que desea anular la certificaci√≥n ${codigo}?`)) {
                const motivo = prompt('Ingrese el motivo de anulaci√≥n:');
                if (motivo) {
                    mostrarAlerta(`Anular certificaci√≥n ${codigo} - Funci√≥n por implementar`, 'info');
                }
            }
        }

        // Funciones de configuraci√≥n completas
function cargarConfiguracion(tipo) {
    const content = document.getElementById('configContent');
    
    switch(tipo) {
        case 'solicitantes':
            mostrarConfigSolicitantes(content);
            break;
        case 'firmantes':
            mostrarConfigFirmantes(content);
            break;
        case 'general':
            mostrarConfigGeneral(content);
            break;
        case 'catalogos':
            mostrarConfigCatalogos(content);
            break;
        default:
            content.innerHTML = '<p>Secci√≥n no encontrada</p>';
    }
}

function mostrarConfigSolicitantes(content) {
    content.innerHTML = `
        <div class="config-section">
            <h3 style="color: #019952;">üë§ Gesti√≥n de Solicitantes</h3>
            <p>Configure los solicitantes que aparecer√°n en el formulario de certificaciones.</p>
            
            <button class="btn" onclick="mostrarFormularioSolicitante()">‚ûï Nuevo Solicitante</button>
            
            <div id="formularioSolicitante" style="display: none; margin-top: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="solicitanteNombre">Nombre Completo *</label>
                        <input type="text" id="solicitanteNombre" required>
                    </div>
                    <div class="form-group">
                        <label for="solicitanteCargo">Cargo *</label>
                        <input type="text" id="solicitanteCargo" required>
                    </div>
                    <div class="form-group">
                        <label for="solicitanteEmail">Email *</label>
                        <input type="email" id="solicitanteEmail" required>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn" onclick="guardarSolicitante()">üíæ Guardar</button>
                    <button class="btn btn-secondary" onclick="cancelarFormularioSolicitante()">‚ùå Cancelar</button>
                </div>
            </div>
            
            <div class="table-container" style="margin-top: 20px;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Cargo</th>
                            <th>Email</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaSolicitantes">
                        ${catalogos.solicitantes.map(sol => `
                            <tr>
                                <td>${sol.id}</td>
                                <td>${sol.nombre}</td>
                                <td>${sol.cargo}</td>
                                <td>${sol.email}</td>
                                <td><span class="status-badge ${sol.activo ? 'status-activa' : 'status-anulada'}">${sol.activo ? 'Activo' : 'Inactivo'}</span></td>
                                <td>
                                    <button class="btn btn-warning" onclick="editarSolicitante('${sol.id}')" style="padding: 5px 8px; font-size: 11px;">‚úèÔ∏è</button>
                                    <button class="btn btn-danger" onclick="eliminarSolicitante('${sol.id}')" style="padding: 5px 8px; font-size: 11px;">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function mostrarConfigFirmantes(content) {
    content.innerHTML = `
        <div class="config-section">
            <h3 style="color: #019952;">‚úçÔ∏è Gesti√≥n de Firmantes</h3>
            <p>Configure los firmantes que aparecer√°n autom√°ticamente en las certificaciones.</p>
            
            <button class="btn" onclick="mostrarFormularioFirmante()">‚ûï Nuevo Firmante</button>
            
            <div id="formularioFirmante" style="display: none; margin-top: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firmanteNombre">Nombre Completo *</label>
                        <input type="text" id="firmanteNombre" required>
                    </div>
                    <div class="form-group">
                        <label for="firmanteCargo">Cargo *</label>
                        <input type="text" id="firmanteCargo" required>
                    </div>
                    <div class="form-group">
                        <label for="firmanteOrden">Orden de Firma *</label>
                        <input type="number" id="firmanteOrden" min="1" max="10" value="1" required>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn" onclick="guardarFirmante()">üíæ Guardar</button>
                    <button class="btn btn-secondary" onclick="cancelarFormularioFirmante()">‚ùå Cancelar</button>
                </div>
            </div>
            
            <div class="table-container" style="margin-top: 20px;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Cargo</th>
                            <th>Orden</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaFirmantes">
                        ${catalogos.firmantes.map(fir => `
                            <tr>
                                <td>${fir.id}</td>
                                <td>${fir.nombre}</td>
                                <td>${fir.cargo}</td>
                                <td>${fir.orden}</td>
                                <td><span class="status-badge ${fir.activo ? 'status-activa' : 'status-anulada'}">${fir.activo ? 'Activo' : 'Inactivo'}</span></td>
                                <td>
                                    <button class="btn btn-warning" onclick="editarFirmante('${fir.id}')" style="padding: 5px 8px; font-size: 11px;">‚úèÔ∏è</button>
                                    <button class="btn btn-danger" onclick="eliminarFirmante('${fir.id}')" style="padding: 5px 8px; font-size: 11px;">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function mostrarConfigGeneral(content) {
    content.innerHTML = `
        <div class="config-section">
            <h3 style="color: #019952;">üîß Configuraci√≥n General</h3>
            <p>Configure los par√°metros generales del sistema.</p>
            
            <form id="formConfigGeneral">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="disposicionBaseLegal">Disposici√≥n/Base Legal por Defecto</label>
                        <textarea id="disposicionBaseLegal" rows="3" placeholder="Ingrese la base legal por defecto...">${configuracion.disposicion_base_legal || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="codigoFormato">Formato de C√≥digo</label>
                        <input type="text" id="codigoFormato" value="${configuracion.codigo_formato || 'CP-{YEAR}-{NUMBER}'}" readonly>
                        <small style="color: #666;">Formato: CP-YYYY-NNNN (no modificable)</small>
                    </div>
                    <div class="form-group">
                        <label for="monedaDefecto">Moneda por Defecto</label>
                        <select id="monedaDefecto">
                            <option value="SOLES" ${configuracion.moneda_por_defecto === 'SOLES' ? 'selected' : ''}>Soles</option>
                            <option value="DOLARES" ${configuracion.moneda_por_defecto === 'DOLARES' ? 'selected' : ''}>D√≥lares</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="timezone">Zona Horaria</label>
                        <select id="timezone">
                            <option value="America/Lima" ${configuracion.timezone === 'America/Lima' ? 'selected' : ''}>Lima, Per√∫</option>
                            <option value="America/Bogota" ${configuracion.timezone === 'America/Bogota' ? 'selected' : ''}>Bogot√°, Colombia</option>
                        </select>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="btn" onclick="guardarConfigGeneral()">üíæ Guardar Configuraci√≥n</button>
                    <button type="button" class="btn btn-secondary" onclick="resetearConfigGeneral()">üîÑ Resetear</button>
                </div>
            </form>
        </div>
    `;
}

function mostrarConfigCatalogos(content) {
    content.innerHTML = `
        <div class="config-section">
            <h3 style="color: #019952;">üìö Gesti√≥n de Cat√°logos</h3>
            <p>Administre los cat√°logos del sistema (iniciativas, tipos, fuentes, etc.).</p>
            
            <div class="nav-tabs" style="margin-bottom: 20px;">
                <button class="nav-tab active" data-subcatalog="iniciativas">üéØ Iniciativas</button>
                <button class="nav-tab" data-subcatalog="tipos">üìã Tipos</button>
                <button class="nav-tab" data-subcatalog="fuentes">üí∞ Fuentes</button>
                <button class="nav-tab" data-subcatalog="finalidades">üé® Finalidades</button>
                <button class="nav-tab" data-subcatalog="oficinas">üè¢ Oficinas</button>
            </div>
            
            <div id="subcatalogoContent">
                <!-- El contenido del subcat√°logo se cargar√° aqu√≠ -->
            </div>
        </div>
    `;
    
    // Configurar eventos para los subcat√°logos
    setTimeout(() => {
        document.querySelectorAll('[data-subcatalog]').forEach(tab => {
            tab.addEventListener('click', function() {
                const subcatalogoId = this.getAttribute('data-subcatalog');
                cambiarSubcatalogo(subcatalogoId);
            });
        });
        
        // Cargar primer subcat√°logo por defecto
        cambiarSubcatalogo('iniciativas');
    }, 100);
}

// Funciones JavaScript para el frontend (agregar al script del index.html):

function mostrarFormularioSolicitante(id = null) {
    const formulario = document.getElementById('formularioSolicitante');
    formulario.style.display = 'block';
    
    if (id) {
        // Modo edici√≥n
        const solicitante = catalogos.solicitantes.find(s => s.id === id);
        if (solicitante) {
            document.getElementById('solicitanteNombre').value = solicitante.nombre;
            document.getElementById('solicitanteCargo').value = solicitante.cargo;
            document.getElementById('solicitanteEmail').value = solicitante.email;
            formulario.dataset.editId = id;
        }
    } else {
        // Modo creaci√≥n
        document.getElementById('solicitanteNombre').value = '';
        document.getElementById('solicitanteCargo').value = '';
        document.getElementById('solicitanteEmail').value = '';
        delete formulario.dataset.editId;
    }
}

function cancelarFormularioSolicitante() {
    const formulario = document.getElementById('formularioSolicitante');
    formulario.style.display = 'none';
    delete formulario.dataset.editId;
}

function guardarSolicitante() {
    const formulario = document.getElementById('formularioSolicitante');
    const nombre = document.getElementById('solicitanteNombre').value;
    const cargo = document.getElementById('solicitanteCargo').value;
    const email = document.getElementById('solicitanteEmail').value;
    
    if (!nombre || !cargo || !email) {
        mostrarAlerta('Por favor, complete todos los campos', 'error');
        return;
    }
    
    const id = formulario.dataset.editId || 'SOL' + (catalogos.solicitantes.length + 1).toString().padStart(3, '0');
    
    const datos = {
        nombre: nombre,
        cargo: cargo,
        email: email,
        activo: true
    };
    
    mostrarLoading(true, 'Guardando solicitante...');
    
    google.script.run
        .withSuccessHandler(resultado => {
            mostrarLoading(false);
            if (resultado.success) {
                mostrarAlerta('Solicitante guardado exitosamente', 'success');
                cancelarFormularioSolicitante();
                // Recargar cat√°logos
                cargarCatalogos().then(() => {
                    cargarConfiguracion('solicitantes');
                });
            } else {
                mostrarAlerta('Error al guardar solicitante: ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(error => {
            mostrarLoading(false);
            mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
        })
        .actualizarSolicitante(id, datos);
}

function editarSolicitante(id) {
    mostrarFormularioSolicitante(id);
}

function eliminarSolicitante(id) {
    if (!confirm('¬øEst√° seguro que desea eliminar este solicitante?')) {
        return;
    }
    
    mostrarLoading(true, 'Eliminando solicitante...');
    
    google.script.run
        .withSuccessHandler(resultado => {
            mostrarLoading(false);
            if (resultado.success) {
                mostrarAlerta('Solicitante eliminado exitosamente', 'success');
                // Recargar cat√°logos
                cargarCatalogos().then(() => {
                    cargarConfiguracion('solicitantes');
                });
            } else {
                mostrarAlerta('Error al eliminar solicitante: ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(error => {
            mostrarLoading(false);
            mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
        })
        .eliminarSolicitante(id);
}

function mostrarFormularioFirmante(id = null) {
    const formulario = document.getElementById('formularioFirmante');
    formulario.style.display = 'block';
    
    if (id) {
        // Modo edici√≥n
        const firmante = catalogos.firmantes.find(f => f.id === id);
        if (firmante) {
            document.getElementById('firmanteNombre').value = firmante.nombre;
            document.getElementById('firmanteCargo').value = firmante.cargo;
            document.getElementById('firmanteOrden').value = firmante.orden;
            formulario.dataset.editId = id;
        }
    } else {
        // Modo creaci√≥n
        document.getElementById('firmanteNombre').value = '';
        document.getElementById('firmanteCargo').value = '';
        document.getElementById('firmanteOrden').value = catalogos.firmantes.length + 1;
        delete formulario.dataset.editId;
    }
}

function cancelarFormularioFirmante() {
    const formulario = document.getElementById('formularioFirmante');
    formulario.style.display = 'none';
    delete formulario.dataset.editId;
}

function guardarFirmante() {
    const formulario = document.getElementById('formularioFirmante');
    const nombre = document.getElementById('firmanteNombre').value;
    const cargo = document.getElementById('firmanteCargo').value;
    const orden = parseInt(document.getElementById('firmanteOrden').value);
    
    if (!nombre || !cargo || !orden) {
        mostrarAlerta('Por favor, complete todos los campos', 'error');
        return;
    }
    
    const id = formulario.dataset.editId || 'FIR' + (catalogos.firmantes.length + 1).toString().padStart(3, '0');
    
    const datos = {
        nombre: nombre,
        cargo: cargo,
        orden: orden,
        activo: true
    };
    
    mostrarLoading(true, 'Guardando firmante...');
    
    google.script.run
        .withSuccessHandler(resultado => {
            mostrarLoading(false);
            if (resultado.success) {
                mostrarAlerta('Firmante guardado exitosamente', 'success');
                cancelarFormularioFirmante();
                // Recargar cat√°logos
                cargarCatalogos().then(() => {
                    cargarConfiguracion('firmantes');
                });
            } else {
                mostrarAlerta('Error al guardar firmante: ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(error => {
            mostrarLoading(false);
            mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
        })
        .actualizarFirmante(id, datos);
}

function editarFirmante(id) {
    mostrarFormularioFirmante(id);
}

function eliminarFirmante(id) {
    if (!confirm('¬øEst√° seguro que desea eliminar este firmante?')) {
        return;
    }
    
    mostrarLoading(true, 'Eliminando firmante...');
    
    google.script.run
        .withSuccessHandler(resultado => {
            mostrarLoading(false);
            if (resultado.success) {
                mostrarAlerta('Firmante eliminado exitosamente', 'success');
                // Recargar cat√°logos
                cargarCatalogos().then(() => {
                    cargarConfiguracion('firmantes');
                });
            } else {
                mostrarAlerta('Error al eliminar firmante: ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(error => {
            mostrarLoading(false);
            mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
        })
        .eliminarFirmante(id);
}

function guardarConfigGeneral() {
    const configuraciones = {
        disposicion_base_legal: document.getElementById('disposicionBaseLegal').value,
        codigo_formato: document.getElementById('codigoFormato').value,
        moneda_por_defecto: document.getElementById('monedaDefecto').value,
        timezone: document.getElementById('timezone').value
    };
    
    mostrarLoading(true, 'Guardando configuraci√≥n...');
    
    google.script.run
        .withSuccessHandler(resultado => {
            mostrarLoading(false);
            if (resultado.success) {
                mostrarAlerta('Configuraci√≥n guardada exitosamente', 'success');
                // Recargar configuraci√≥n
                cargarConfiguracion();
            } else {
                mostrarAlerta('Error al guardar configuraci√≥n: ' + resultado.error, 'error');
            }
        })
        .withFailureHandler(error => {
            mostrarLoading(false);
            mostrarAlerta('Error de conexi√≥n: ' + error.message, 'error');
        })
        .actualizarConfiguracionGeneral(configuraciones);
}

function resetearConfigGeneral() {
    if (!confirm('¬øEst√° seguro que desea resetear la configuraci√≥n a los valores por defecto?')) {
        return;
    }
    
    document.getElementById('disposicionBaseLegal').value = 'Directiva 003-2023-SG/CARITASLIMA, Directiva de contrataci√≥n de bienes y servicios de la Vicar√≠a de Pastoral Social y Dignidad Humana - Caritas Lima';
    document.getElementById('codigoFormato').value = 'CP-{YEAR}-{NUMBER}';
    document.getElementById('monedaDefecto').value = 'SOLES';
    document.getElementById('timezone').value = 'America/Lima';
}

function cambiarSubcatalogo(subcatalogoId) {
    document.querySelectorAll('[data-subcatalog]').forEach(tab => {
        tab.classList.remove('active');
    });
    
    const selectedTab = document.querySelector(`[data-subcatalog="${subcatalogoId}"]`);
    if (selectedTab) {
        selectedTab.classList.add('active');
        mostrarSubcatalogo(subcatalogoId);
    }
}

function mostrarSubcatalogo(tipo) {
    const content = document.getElementById('subcatalogoContent');
    const tipoNombre = {
        'iniciativas': 'Iniciativas',
        'tipos': 'Tipos',
        'fuentes': 'Fuentes de Financiamiento',
        'finalidades': 'Finalidades',
        'oficinas': 'Oficinas'
    };
    
    content.innerHTML = `
        <h4 style="color: #019952;">${tipoNombre[tipo] || tipo}</h4>
        <p>Gestione los elementos del cat√°logo de ${tipoNombre[tipo]?.toLowerCase() || tipo}.</p>
        
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nombre</th>
                        <th>Descripci√≥n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${catalogos[tipo]?.map(item => `
                        <tr>
                            <td>${item.codigo}</td>
                            <td>${item.nombre}</td>
                            <td>${item.descripcion || ''}</td>
                            <td><span class="status-badge ${item.activo ? 'status-activa' : 'status-anulada'}">${item.activo ? 'Activo' : 'Inactivo'}</span></td>
                            <td>
                                <button class="btn btn-warning" onclick="editarItemCatalogo('${tipo}', '${item.codigo}')" style="padding: 5px 8px; font-size: 11px;">‚úèÔ∏è</button>
                                <button class="btn ${item.activo ? 'btn-danger' : 'btn-info'}" onclick="toggleItemCatalogo('${tipo}', '${item.codigo}')" style="padding: 5px 8px; font-size: 11px;">
                                    ${item.activo ? '‚ùå' : '‚úÖ'}
                                </button>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="5" class="no-data">No hay elementos en este cat√°logo</td></tr>'}
                </tbody>
            </table>
        </div>
    `;
}

function editarItemCatalogo(tipo, codigo) {
    mostrarAlerta(`Editar ${tipo} - ${codigo} - Funci√≥n por implementar`, 'info');
}

function toggleItemCatalogo(tipo, codigo) {
    mostrarAlerta(`Toggle ${tipo} - ${codigo} - Funci√≥n por implementar`, 'info');
}

        // Funciones de certificaciones m√∫ltiples (simplificadas)
        function agregarCertificacionMultiple() {
            mostrarAlerta('Funci√≥n de certificaciones m√∫ltiples - Por implementar', 'info');
        }

        function crearCertificacionesMultiples() {
            mostrarAlerta('Funci√≥n de certificaciones m√∫ltiples - Por implementar', 'info');
        }

        function limpiarCertificacionesMultiples() {
            document.getElementById('certificacionesMultiples').innerHTML = '';
        }

        // Funci√≥n de vista previa
        function previsualizarCertificacion() {
            mostrarAlerta('Vista previa - Por implementar', 'info');
        }

        // Funciones de reportes (simplificadas)
        function generarReporte() {
            mostrarAlerta('Generaci√≥n de reportes - Por implementar', 'info');
        }
    </script>
</body>
</html>